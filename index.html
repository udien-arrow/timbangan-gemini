<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Timbangan Profesional</title>
    <style>
        :root {
            --primary-color: #0056b3;
            --secondary-color: #495057;
            --background-color: #f4f7f9;
            --surface-color: #ffffff;
            --border-color: #dee2e6;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--background-color);
            color: var(--secondary-color);
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .main-container {
            display: flex;
            gap: 20px;
            width: 100%;
            max-width: 1200px;
        }

        .left-panel, .right-panel {
            background-color: var(--surface-color);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .right-panel {
            flex: 2;
        }

        h1, h2, h3 {
            color: var(--primary-color);
            margin-top: 0;
        }

        #weight-display {
            font-size: 4.5rem;
            font-weight: 700;
            color: var(--primary-color);
            background-color: #e9ecef;
            padding: 20px 40px;
            border-radius: 8px;
            margin-bottom: 20px;
            min-width: 300px;
            text-align: center;
        }

        #status {
            font-weight: 500;
        }
        .connected { color: var(--success-color); }
        .disconnected { color: var(--danger-color); }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 86, 179, 0.2);
        }

        .weigh-group {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        .weigh-group input {
            background-color: #e9ecef;
            font-weight: bold;
        }

        .btn {
            padding: 10px 15px;
            font-size: 1rem;
            font-weight: 500;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            color: white;
        }

        .btn-primary { background-color: var(--primary-color); }
        .btn-primary:hover { background-color: #004494; }
        .btn-success { background-color: var(--success-color); }
        .btn-success:hover { background-color: #218838; }
        .btn-info { background-color: #17a2b8; }
        .btn-info:hover { background-color: #138496; }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-secondary:hover { background-color: #3e444a; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }

        .history-section {
            margin-top: 30px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .history-table th, .history-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .history-table th {
            background-color: #f8f9fa;
        }
        
        #app-status {
            margin-top: 10px;
            height: 1.2em;
            font-weight: 500;
        }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="left-panel">
            <h2>Timbangan Real-Time</h2>
            <div id="weight-display">0 g</div>
            <div id="status">Status: <span class="disconnected">Terputus</span></div>
            <hr style="width:100%; margin: 20px 0;">
            <button id="toggle-settings-btn" class="btn btn-secondary">Pengaturan Koneksi</button>
            <div class="settings-section" id="settings-section">
                <h3>Pengaturan</h3>
                <div class="form-group">
                    <label for="port-path-input">Port Path</label>
                    <input type="text" id="port-path-input">
                </div>
                <div class="form-group">
                    <label for="baud-rate-select">Baud Rate</label>
                    <select id="baud-rate-select"><option value="9600">9600</option></select>
                </div>
                <div class="form-group">
                    <label for="stop-bits-select">Stop Bits</label>
                    <select id="stop-bits-select"><option value="1">1</option><option value="2">2</option></select>
                </div>
                <div class="form-group">
                    <label for="parity-select">Parity</label>
                    <select id="parity-select"><option value="none">None</option></select>
                </div>
                <button id="save-settings-btn" class="btn btn-primary" style="width:100%;">Simpan</button>
                <div id="settings-status"></div>
            </div>
        </div>

        <div class="right-panel">
            <h2>Form Penimbangan</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="do_number">No. Surat Jalan</label>
                    <input type="text" id="do_number" name="do_number">
                </div>
                <div class="form-group">
                    <label for="plate_number">Plat Nomor</label>
                    <input type="text" id="plate_number" name="plate_number">
                </div>
                <div class="form-group">
                    <label for="vendor_name">Nama Vendor</label>
                    <input type="text" id="vendor_name" name="vendor_name">
                </div>
                <div class="form-group">
                    <label for="item_name">Nama Barang</label>
                    <input type="text" id="item_name" name="item_name">
                </div>
            </div>

            <hr style="margin: 20px 0;">

            <div class="form-grid">
                <div class="form-group">
                    <label>Timbang 1</label>
                    <div class="weigh-group">
                        <input type="text" id="weight_1" readonly>
                        <button id="capture-weight-1-btn" class="btn btn-primary">Ambil</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Timbang 2</label>
                    <div class="weigh-group">
                        <input type="text" id="weight_2" readonly>
                        <button id="capture-weight-2-btn" class="btn btn-primary">Ambil</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Bruto</label>
                    <input type="text" id="gross_weight" readonly>
                </div>
                <div class="form-group">
                    <label>Tare</label>
                    <input type="text" id="tare_weight" readonly>
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>Netto</label>
                    <input type="text" id="net_weight" readonly style="font-size: 1.5rem; text-align:center; font-weight: bold; color: var(--primary-color);">
                </div>
            </div>

            <div class="action-buttons">
                <button id="save-transaction-btn" class="btn btn-success">Simpan Transaksi</button>
                <button id="reset-form-btn" class="btn btn-secondary">Form Baru</button>
                <button id="print-btn" class="btn btn-info" style="display: none;">Cetak</button>
            </div>
            <div id="app-status"></div>

            <div class="history-section">
                <h3>Riwayat Transaksi Terakhir</h3>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>No. Surat Jalan</th>
                            <th>Vendor</th>
                            <th>Barang</th>
                            <th>Netto (g)</th>
                            <th>Waktu</th>
                        </tr>
                    </thead>
                    <tbody id="history-body">
                        <!-- Riwayat akan dimuat di sini -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- Elemen DOM ---
        const dom = {
            weightDisplay: document.getElementById('weight-display'),
            transactionId: document.createElement('input'), // Hidden input for transaction ID
            statusSpan: document.getElementById('status').querySelector('span'),
            doNumber: document.getElementById('do_number'),
            plateNumber: document.getElementById('plate_number'),
            vendorName: document.getElementById('vendor_name'),
            itemName: document.getElementById('item_name'),
            weight1: document.getElementById('weight_1'),
            weight2: document.getElementById('weight_2'),
            grossWeight: document.getElementById('gross_weight'),
            tareWeight: document.getElementById('tare_weight'),
            netWeight: document.getElementById('net_weight'),
            capture1Btn: document.getElementById('capture-weight-1-btn'),
            capture2Btn: document.getElementById('capture-weight-2-btn'),
            saveBtn: document.getElementById('save-transaction-btn'),
            resetBtn: document.getElementById('reset-form-btn'),
            printBtn: document.getElementById('print-btn'),
            historyBody: document.getElementById('history-body'),
            appStatus: document.getElementById('app-status'),
            // Pengaturan
            toggleSettingsBtn: document.getElementById('toggle-settings-btn'),
            settingsSection: document.getElementById('settings-section'),
        };

        dom.transactionId.type = 'hidden';

        let lastKnownWeight = 0;

        // --- FUNGSI UTAMA ---

        function updateCalculations() {
            const w1 = parseInt(dom.weight1.value) || 0;
            const w2 = parseInt(dom.weight2.value) || 0;

            if (w1 === 0 && w2 === 0) {
                dom.grossWeight.value = '';
                dom.tareWeight.value = '';
                dom.netWeight.value = '';
                return;
            }

            const gross = Math.max(w1, w2);
            const tare = Math.min(w1, w2);
            const net = gross - tare;

            dom.grossWeight.value = `${gross} g`;
            dom.tareWeight.value = `${tare} g`;
            dom.netWeight.value = `${net} g`;
        }

        function resetForm() {
            const fields = [
                'doNumber', 'plateNumber', 'vendorName', 'itemName',
                'weight1', 'weight2', 'grossWeight', 'tareWeight', 'netWeight',
                'transactionId'
            ];
            fields.forEach(field => dom[field].value = '');
            // Re-enable all fields and buttons
            dom.saveBtn.disabled = false;
            dom.printBtn.style.display = 'none';
            [dom.doNumber, dom.plateNumber, dom.vendorName, dom.itemName, dom.capture1Btn].forEach(el => el.disabled = false);
            setAppStatus('');
        }

        async function findPendingTransaction() {
            const plateNumber = dom.plateNumber.value.trim();
            if (!plateNumber) return;

            setAppStatus('Mencari transaksi pending...', 'orange');
            try {
                const response = await fetch(`http://${window.location.hostname}:8080/api/transactions/pending/${plateNumber}`);
                if (response.status === 404) {
                    setAppStatus('Tidak ada data Timbang 1. Siap untuk transaksi baru.', 'blue');
                    return;
                }
                if (!response.ok) throw new Error('Gagal mencari data.');
                
                const pendingTx = await response.json();
                populateFormWithPendingData(pendingTx);
                setAppStatus('Data Timbang 1 ditemukan. Siap untuk Timbang 2.', 'green');
            } catch (error) {
                setAppStatus(`Error: ${error.message}`, 'red');
            }
        }

        function populateFormWithPendingData(tx) {
            dom.transactionId.value = tx.id;
            dom.doNumber.value = tx.do_number;
            dom.plateNumber.value = tx.plate_number;
            dom.vendorName.value = tx.vendor_name;
            dom.itemName.value = tx.item_name;
            dom.weight1.value = `${tx.weight_1} g`;

            // Lock the fields that are already filled
            [dom.doNumber, dom.plateNumber, dom.vendorName, dom.itemName, dom.capture1Btn].forEach(el => el.disabled = true);
        }

        async function saveTransaction() {
            const transactionId = dom.transactionId.value;
            
            if (transactionId) {
                // This is Timbang 2 (Update)
                const w1 = parseInt(dom.weight1.value) || 0;
                const w2 = parseInt(dom.weight2.value) || 0;
                if (w2 === 0) {
                    alert('Silakan lakukan Timbang 2 terlebih dahulu.');
                    return;
                }
                const updateData = {
                    weight_2: w2,
                    gross_weight: Math.max(w1, w2),
                    tare_weight: Math.min(w1, w2),
                    net_weight: Math.abs(w1 - w2)
                };
                await sendRequest(`/api/transactions/${transactionId}`, 'PUT', updateData);
            } else {
                // This is Timbang 1 (Create)
                const createData = {
                    do_number: dom.doNumber.value.trim(),
                    plate_number: dom.plateNumber.value.trim(),
                    vendor_name: dom.vendorName.value.trim(),
                    item_name: dom.itemName.value.trim(),
                    weight_1: parseInt(dom.weight1.value) || 0
                };
                 for (const key in createData) {
                    if (!createData[key] && key !== 'weight_1') { // weight_1 can be 0
                        alert(`Data "${key.replace('_', ' ')}" harus diisi.`);
                        return;
                    }
                }
                if (!dom.weight1.value) {
                    alert('Silakan lakukan Timbang 1 terlebih dahulu.');
                    return;
                }
                await sendRequest('/api/transactions', 'POST', createData);
            }
        }

        async function sendRequest(endpoint, method, data) {
            setAppStatus('Menyimpan...', 'var(--warning-color)');
            try {
                const response = await fetch(`http://${window.location.hostname}:8080${endpoint}`, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Gagal menyimpan.');

                setAppStatus(result.message, 'green');
                if (method === 'PUT' && result.transactionId) {
                    // Transaksi selesai, siapkan tombol cetak
                    dom.saveBtn.disabled = true;
                    dom.printBtn.dataset.id = result.transactionId;
                    dom.printBtn.style.display = 'inline-block';
                } else {
                    // Ini adalah Timbang 1, reset form
                    resetForm();
                }
                loadHistory(); // Selalu muat ulang riwayat
            } catch (error) {
                setAppStatus(`Error: ${error.message}`, 'red');
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch(`http://${window.location.hostname}:8080/api/transactions`); // This now gets completed transactions
                if (!response.ok) throw new Error('Gagal memuat riwayat.');
                const history = await response.json();

                dom.historyBody.innerHTML = '';
                if (history.length === 0) {
                    dom.historyBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Belum ada riwayat.</td></tr>';
                } else {
                    history.forEach(item => {
                        const row = dom.historyBody.insertRow();
                        const timestamp = new Date(item.created_at).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' });
                        row.innerHTML = `
                            <td>${item.do_number}</td>
                            <td>${item.vendor_name}</td>
                            <td>${item.item_name}</td>
                            <td>${item.net_weight}</td>
                            <td>${timestamp.replace('.',':')}</td>
                        `;
                    });
                }
            } catch (error) {
                console.error('Error memuat riwayat:', error);
                dom.historyBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Error: ${error.message}</td></tr>`;
            }
        }

        function setAppStatus(message, color = 'black') {
            dom.appStatus.textContent = message;
            dom.appStatus.style.color = color;
        }

        // --- KONEKSI WEBSOCKET ---
        function connectWebSocket() {
            const socket = new WebSocket(`ws://${window.location.hostname}:8080`);

            socket.onopen = () => {
                dom.statusSpan.textContent = 'Terhubung';
                dom.statusSpan.className = 'connected';
                [dom.capture1Btn, dom.capture2Btn].forEach(btn => btn.disabled = false);
            };

            socket.onmessage = (event) => {
                const weightData = event.data;
                if (weightData) {
                    dom.weightDisplay.textContent = weightData;
                    lastKnownWeight = parseInt(weightData) || 0;
                }
            };

            socket.onclose = () => {
                dom.statusSpan.textContent = 'Terputus. Mencoba lagi...';
                dom.statusSpan.className = 'disconnected';
                [dom.capture1Btn, dom.capture2Btn].forEach(btn => btn.disabled = true);
                setTimeout(connectWebSocket, 3000);
            };

            socket.onerror = (error) => {
                console.error('WebSocket Error:', error);
                dom.statusSpan.textContent = 'Error Koneksi';
                dom.statusSpan.className = 'disconnected';
            };
        }

        // --- EVENT LISTENERS ---
        dom.capture1Btn.addEventListener('click', () => {
            dom.weight1.value = `${lastKnownWeight} g`;
            updateCalculations();
        });

        dom.capture2Btn.addEventListener('click', () => {
            dom.weight2.value = `${lastKnownWeight} g`;
            updateCalculations();
        });

        dom.printBtn.addEventListener('click', () => {
            const txId = dom.printBtn.dataset.id;
            if (txId) window.open(`cetak.html?id=${txId}`, '_blank');
        });

        dom.plateNumber.addEventListener('blur', findPendingTransaction);

        dom.saveBtn.addEventListener('click', saveTransaction);
        dom.resetBtn.addEventListener('click', resetForm);
        dom.toggleSettingsBtn.addEventListener('click', () => {
            dom.settingsSection.style.display = dom.settingsSection.style.display === 'block' ? 'none' : 'block';
        });

        // --- INISIALISASI ---
        function initializeApp() {
            [dom.capture1Btn, dom.capture2Btn].forEach(btn => btn.disabled = true);
            // Kode untuk memuat pengaturan koneksi bisa ditambahkan di sini jika diperlukan
            connectWebSocket();
            loadHistory();
        }

        initializeApp();
    </script>
</body>
</html>
